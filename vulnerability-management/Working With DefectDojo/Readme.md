# Working With DefectDojo

In this scenario, you will learn how to use DefectDojo to manage vulnerabilities in a DevSecOps environment.

You will run a Brakeman scan on a repository and upload the results to DefectDojo.

## DefectDojo Model

> DefectDojo is a security tool that automates application security vulnerability management. It streamlines the application security testing process by offering features such as importing third-party security findings, merging and de-duping, integration with Jira, templating, report generation, and security metrics.
Source: [https://defectdojo.github.io/django-DefectDojo](https://defectdojo.github.io/django-DefectDojo)

After logging into the DefectDojo system, you’ll see a default dashboard showing 1 Engagement, 0 Findings, and empty metrics.

Machine Details	
URL:	dojo-p30jrhut.lab.practical-devsecops.training/
Username:	root
Password:	pdso-training

## Product Type
Product Type is the top-level model in DefectDojo. It’s associated with other components like Product, Engagement, Finding, Endpoint, and Benchmark. You can use this model to categorize your products based on division, department, function, portfolio, application type, etc.

In the DefectDojo machine, you’ll find the All Product Types option in the sidebar. You’ll see two types: Research and Development and Web Application.

You can decide on product types with your team based on how your organization, teams, and products are structured.

The general guideline is that product types should help manage and visualize vulnerabilities effectively, so necessary vulnerability metrics are shared with various teams accordingly.

## Product
This is the name of your project, program, or product whose vulnerabilities need to be managed. For example, Django API, Django Web, or a specific name like Django - Payment Service.

## Engagement
Your testing activity, associated with a name, timeline, how many tests are run, findings.

## Test
Tests are groups of activities conducted by engineers to discover vulnerabilities in a product. DefectDojo supports importing and managing vulnerabilities from a wide range of security tools including, but not limited to, Bandit, ZAP, BurpSuite, Checkmarx, Acunetix, Nessus, etc.
> Learn more about integrations: https://defectdojo.github.io/django-DefectDojo/en/connecting_your_tools/parsers/file/

## Finding
Findings represent vulnerabilities discovered during testing. They are categorized by severity: Critical, High, Medium, Low, and Informational.

## Endpoint
An Endpoint represents the domain name or IP address of systems under test.

Let’s move to the next step.

## Run the Scanner

## Download the Source Code
Let’s start by downloading the source code for our sample Rails project. We’ll perform all exercises locally on the DevSecOps-Box.

First, let’s download the source code of our sample Rails project from the git repository.
```
git clone https://gitlab.practical-devsecops.training/pdso/rails.git webapp
cd webapp
```

Great! We have successfully navigated to the webapp directory. This is where we’ll perform our scan.

## Install SAST Tool
> Note:
> Installing the tool directly on your system can be time-consuming. Instead, we’ll use Docker to run the scanner, which is faster and doesn’t require installing additional libraries.

We will use Docker to run the Brakeman scanner on our system to perform static analysis.
<br>`docker run --rm -v $(pwd):/src hysnsec/brakeman -f json /src`

As we learned in the DevSecOps Gospel, it’s important to store scan results in a JSON file. To achieve this, we’ll use the tee command. This command allows us to display the output on the screen and save it to a file at the same time.
<br>
`docker run --rm -v $(pwd):/src hysnsec/brakeman -f json /src | tee brakeman-result.json`

As you can see, Brakeman has completed its scan successfully and identified several security issues.

In the next step, we’ll learn how to upload this results file to DefectDojo for further analysis and management.

## Create a New Engagement
In this step, we’ll create a new engagement for our Ruby application.

First, log into DefectDojo using these credentials:

Let’s start by creating a “Product”. In the sidebar, click on Add Product and fill in the form with this information:
![image](https://github.com/user-attachments/assets/589df64a-10c8-424a-849e-2e99e07f4647)

Leave other form fields empty. In real-world scenarios, you’d fill in the Product manager, Technical contact, and Team manager fields. We only have one user named root, so if you want to add more specific users, create them first before assigning them to the new product.

Click the Submit button to create your product in DefectDojo.

Now, we can’t upload any scan reports because there’s no engagement. Let’s create one by clicking on Engagements in the menu and selecting Add New Interactive Engagement.

Fill in the form with this information:
![image](https://github.com/user-attachments/assets/c64a8949-0749-42ce-851f-a04b395e335e)

You can fill in other optional fields if you like, such as Version or Repo, etc. Fields marked with a * symbol are mandatory.

Click the Done button.

In the next step, we’ll explore how to programmatically upload the Brakeman result to DefectDojo.

## Upload the Results to DefectDojo
> DefectDojo provides an API to upload scan results, which is an excellent feature for integrating with CI/CD processes.

> Not all security scanners can be integrated with DefectDojo.
> Please refer to this [link](https://www.defectdojo.com/integrations) to check the available security scanners.

We have created a simple upload script for you. You can download this script using the following command:
```
curl https://gitlab.practical-devsecops.training/-/snippets/28/raw -o upload-results.py
```

After downloading the upload-results.py script, we need to install the requests module using pip3. This is because the upload-results.py script uses methods from the Python requests module.
```
pip3 install requests
```
Now, let’s take a look at the options available in the upload-results.py script.
```
python3 upload-results.py --help

usage: upload-results.py [-h] --host HOST --api_key API_KEY --engagement_id
                         ENGAGEMENT_ID --result_file RESULT_FILE --scanner
                         SCANNER --product_id PRODUCT_ID --lead_id LEAD_ID
                         [--build_id BUILD_ID]

CI/CD integration for DefectDojo

optional arguments:
  -h, --help            show this help message and exit
  --host HOST           DefectDojo Hostname
  --api_key API_KEY     API v2 Key
  --engagement_id ENGAGEMENT_ID
                        Engagement ID
  --result_file RESULT_FILE
                        Scanner file
  --scanner SCANNER     Type of scanner
  --product_id PRODUCT_ID
                        DefectDojo Product ID
  --lead_id LEAD_ID     ID of the user conducting the testing
  --environment ENVIRONMENT
                        Environment name
  --build_id BUILD_ID   Reference to external build id
```

To use the upload-results.py script effectively, we need to provide the following inputs:
![image](https://github.com/user-attachments/assets/7e90d174-20e6-4bb3-b06e-7b4d19553a94)

> Remember the first note from this step? That’s where you can find the list of supported scanner names.

![image](https://github.com/user-attachments/assets/a4addd5f-f1bc-4747-ba44-4234a11e3eed)

To work with DefectDojo programmatically, we need to authenticate using an API key. Let’s get an API key using curl and save it as an environment variable called API_KEY. Use the following command:
```
export API_KEY=$(curl -s -XPOST -H 'content-type: application/json' https://dojo-p30jrhut.lab.practical-devsecops.training/api/v2/api-token-auth/ -d '{"username": "root", "password": "pdso-training"}' | jq -r '.token' )
```

Make sure the API_KEY displays an output when you run the echo $API_KEY command. If you don’t see the API_KEY echoed, please check that you can access the URL https://dojo-p30jrhut.lab.practical-devsecops.training/api/v2 after entering your DefectDojo credentials.

If you can’t access the provided URL, please wait for 2 minutes to allow DefectDojo to fully provision. If you still can’t access it after waiting, you may need to restart the exercise. This is because the DefectDojo machine might have automatically shut down after its two-hour lifetime.

Now that we have our API key, we can upload the Brakeman scan output (stored in the file brakeman-result.json) to DefectDojo.
```
python3 upload-results.py --host dojo-p30jrhut.lab.practical-devsecops.training --api_key $API_KEY --engagement_id 2 --product_id 3 --lead_id 1 --environment "Production" --result_file brakeman-result.json --scanner "Brakeman Scan"
```
> Note
> Your engagement ID and product ID may differ from those in the example command. To find the correct IDs, visit DefectDojo and check the URL when viewing an engagement or product. For example, you might see /engagement/3 in the URL, indicating an engagement ID of 3.

After uploading the results, visit https://dojo-p30jrhut.lab.practical-devsecops.training/engagement/2 to review the uploaded issues.

You should now see the scan results in the engagement we created earlier.
![image](https://github.com/user-attachments/assets/c8d57f42-a30e-4a2e-99c6-97afd8048d4a)
![image](https://github.com/user-attachments/assets/41fc836e-f672-4725-a1e9-3c241f61dd98)

Select the Brakeman Scan, and you will see many issues with Medium severity.

You can also mark issues as False Positives. To do this, follow these steps:

- Click on the checkbox of one of the issues.
- Look for the Bulk Edit option.
- Choose Medium for the Severity type.
- Check the False Positive button.
- Click the Submit button.
For details, please refer to the following screenshots:
![image](https://github.com/user-attachments/assets/b8eeaa81-8562-4344-bd05-bd40da61920f)
![image](https://github.com/user-attachments/assets/178bd0f9-bea7-4c97-a2e1-0e89348d32d0)
![image](https://github.com/user-attachments/assets/8c0bf4bc-fd3c-492c-8653-91a30444674c)

After completing these steps, the status of the vulnerability will change to Inactive, False Positive.


