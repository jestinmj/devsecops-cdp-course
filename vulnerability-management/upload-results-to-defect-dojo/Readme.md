Vulnerability Management with DefectDojo
================================

Learn how to use Defect Dojo to manage vulnerabilities
----------------------------------------------------------------

In this scenario, you will learn how to use Defect Dojo to manage vulnerabilities in a DevSecOps environment.

You will run bandit scan on a repository and then upload the results to Defect Dojo.

To achieve the above objectives, you will need to do the following.
1. Clone/download the source code
2. Install bandit tool
3. Run the SAST scan on the source code
4. Upload the result to DefectDojo with custom script

Download the source code
----------

We will do all the exercises locally first in DevSecOps-Box, so let’s start the exercise.

First, we need to download the source code of the project from our git repository.

```
git clone https://gitlab.practical-devsecops.training/pdso/django.nv webapp
cd webapp
```

Install Bandit
----------
> The Bandit is a tool designed to find common security issues in Python code.
> It processes each file, builds an Abstract Syntax Tree (AST), and runs appropriate plugins against the AST nodes. After scanning all files, Bandit generates a report.
> Bandit was originally developed within the OpenStack Security Project and later rehomed to PyCQA.
> You can find more details about the project at https://github.com/PyCQA/bandit.

Let’s install the bandit scanner on the system to perform static analysis.

```
pip3 install bandit
```
We have successfully installed the bandit scanner.

Run the scanner
----------

As we have learned in the DevSecOps Gospel, we would like to store the tool results in a JSON file. We are using the tee command here to show the output and store it in a file simultaneously.

```
bandit -r . -f json | tee bandit-output.json
```

Bandit ran successfully, and it found seven security issues.
1. One high severity issue
2. Five medium severity issue
3. One low severity issue
   
Let’s upload this file to Defect Dojo in the next step.

Upload the results to Defect Dojo
-----------

Let’s explore the Defect Dojo application now.

> Defect Dojo provides an API to upload the scan results, and this is an excellent feature for uploading scan results during CI/CD process. We have created a simple upload script for you, and you can download this script using the following command.

> Not all security scanners can be integrated and used for uploading results to DefectDojo.
> Please refer to this link to check the available security scanners.
> ![image](https://github.com/user-attachments/assets/d9fba7f1-013b-4629-8ee5-28a10b92f3b3)

We have created a simple upload script for you. You can download this script using the following command:
```
curl https://gitlab.practical-devsecops.training/-/snippets/28/raw -o upload-results.py
python3 upload-results.py --help
```

output

```
Traceback (most recent call last):
  File "upload-results.py", line 7, in <module>
    import requests
ModuleNotFoundError: No module named 'requests'
```
It looks like the module requests is not available. Lets install it and upload the results.

```
pip3 install requests
```
Now, we can try re-running the command and see if it works.
```
python3 upload-results.py --help
```
output
```
usage: upload-results.py [-h] --host HOST --api_key API_KEY --engagement_id
                         ENGAGEMENT_ID --result_file RESULT_FILE --scanner
                         SCANNER --product_id PRODUCT_ID --lead_id LEAD_ID
                         [--build_id BUILD_ID]

CI/CD integration for DefectDojo

optional arguments:
  -h, --help            show this help message and exit
  --host HOST           DefectDojo Hostname
  --api_key API_KEY     API v2 Key
  --engagement_id ENGAGEMENT_ID
                        Engagement ID
  --result_file RESULT_FILE
                        Scanner file
  --scanner SCANNER     Type of scanner
  --product_id PRODUCT_ID
                        DefectDojo Product ID
  --lead_id LEAD_ID     ID of the user conducting the testing
  --environment ENVIRONMENT
                        Environment name
  --build_id BUILD_ID   Reference to external build id
```

We need to provide the following inputs for this script to work.

- Host : https://dojo-XqiHnDZ0.lab.practical-devsecops.training
- Username : root
- API_KEY : Find it at https://dojo-XqiHnDZ0.lab.practical-devsecops.training/api/key-v2
- ENGAGEMENT_ID: ID of the engagement, here its 1
- PRODUCT_ID: ID of product, here its 1
- LEAD_ID: ID of the user conducting the testing
- ENVIRONMENT: Environment name
- SCANNER: Name of the scanner, this is case sensitive e.g., ZAP Scan, Bandit Scan, etc
- RESULT_FILE: The path to the tool’s output

You need to first log into the dojo website using the following credentials to fetch the API Key.

- Dojo URL: https://dojo-xqihndz0.lab.practical-devsecops.training/api/key-v2
- Username: root
- Password: pdso-training

To set up your API key, follow these steps:

Copy the API_KEY from the DefectDojo application.
Replace INSERT_API_KEY_HERE with your actual API key in the command below.

```
export API_KEY=INSERT_API_KEY_HERE
```
You can also use the following command to get a token programmatically.

```
export API_KEY=$(curl -s -XPOST -H 'content-type: application/json' https://dojo-p30jrhut.lab.practical-devsecops.training/api/v2/api-token-auth/ -d '{"username": "root", "password": "pdso-training"}' | jq -r '.token' )
```

> Make sure the API_KEY shows an output when executing echo $API_KEY command. If not, you need to wait until the DefectDojo is ready.

We can now upload the bandit’s scan output (bandit-output.json) to Defect Dojo.

```
python3 upload-results.py --host dojo-p30jrhut.lab.practical-devsecops.training --api_key $API_KEY --engagement_id 1 --product_id 1 --lead_id 1 --environment "Production" --result_file bandit-output.json --scanner "Bandit Scan"
```
output
```
{'Authorization': 'Token 6af287e26400d905720156c5e0965ea236dabe35'}
{'minimum_severity': 'Low', 'scan_date': '2021-02-16', 'verified': False, 'active': False, 'engagement': '1', 'lead': '1', 'scan_type': 'Bandit Scan', 'environment': 'Production'}
Successfully uploaded the results to Defect Dojo
```

Visit the https://dojo-XqiHnDZ0.lab.practical-devsecops.training/engagement/1 to see the uploaded issues.
![image](https://github.com/user-attachments/assets/eaf58c99-ea71-4463-b4ba-74c99315e1ac)


Exercise: Upload ZAP results to Defect Dojo manually
----
In this exercise, you will use the upload-results.py script to upload the ZAP Scan results to the Defect Dojo.

To complete this challenge, please follow these steps:
- Explore the various features DefectDojo offers, paying attention to URL changes in your browser’s address bar.
- Make sure to visit at least the product page, engagement page, and test options in the DefectDojo portal.
- Note that the 500 error you may encounter while uploading ZAP’s output is due to incorrect arguments being used.
- To resolve this error, please refer to the DefectDojo documentation at https://docs.defectdojo.com/en/connecting_your_tools/parsers/file/.



1. Scan the production machine `https://prod-p30jrhut.lab.practical-devsecops.training` with the help of the ZAP docker image `softwaresecurityproject/zap-stable:2.14.0`, and save the results to `/webapp/zap-output.xml`
  > Refer to the exercise How to Embed Zed Attack Proxy (ZAP) into GitLab. Set the output to XML format using the flags -d -x zap-output.xml
  ```
   docker run --user $(id -u):$(id -g) -w /zap -v $(pwd):/zap/wrk:rw \
           --rm softwaresecurityproject/zap-stable:2.14.0 zap-baseline.py \
           -t https://prod-p30jrhut.lab.practical-devsecops.training \
           -d -x zap-output.xml
  ```
2. Store the ZAP scan results in a file and upload the results to Defect Dojo
```
python3 upload-results.py --host dojo-p30jrhut.lab.practical-devsecops.training \
    --api_key $API_KEY --engagement_id 1 --product_id 1 \
    --lead_id 1 --environment "Production" \
    --result_file /webapp/zap-output.xml \
    --scanner "ZAP Scan"
```













> Please do not forget to share the answer (a screenshot and commands) with our staff via Slack Direct Message (DM).

Hint
---------

Explore the different features Dojo provides while keeping a note of URL changes in the address bar of your browser
Atleast visit, product page, engagement page and tests options in the Dojo portal
The 500 error while uploading ZAP’s output is because of the wrong arguments used. Please read the documentation of Dojo to resolve the error

Answer
---------
1. Scan the production machine https://prod-XqiHnDZ0.lab.practical-devsecops.training with the help of the ZAP docker image
```
docker run --user $(id -u):$(id -g) -w /zap -v $(pwd):/zap/wrk:rw --rm owasp/zap2docker-stable zap-baseline.py -t https://prod-XqiHnDZ0.lab.practical-devsecops.training -x zap-output.xml
```

2. Store the ZAP scan results in a file and upload the results to Defect Dojo

```
python3 upload-results.py --host dojo-XqiHnDZ0.lab.practical-devsecops.training --api_key $API_KEY --engagement_id 1 --product_id 1 --lead_id 1 --environment "Production" --result_file zap-output.xml --scanner "ZAP Scan"
```
